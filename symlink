#!/usr/bin/env bash

HOST=$(hostname)
if [[ ! -z "$1" ]]; then
    HOST="$1"
fi

FILES=(
  "secrets.nix"
  "hosts/${HOST}/configuration.nix" 
  "hosts/${HOST}/hardware-configuration.nix" 
)

for FILE in ${FILES[@]}; do
    if [[ ! -e "${FILE}" ]]; then
        echo "Missing '${FILE}' file!" >&2
        exit 1
    fi
done

# symlink host config
ln -vsf "${PWD}/hosts/${HOST}/configuration.nix" "${PWD}"
ln -vsf "${PWD}/hosts/${HOST}/hardware-configuration.nix" "${PWD}"

# and then the whole dir
if [[ "${PWD}" != "/etc/nixos" ]]; then
    rm -r "/etc/nixos"
    ln -vsf "${PWD}" "/etc/nixos"
fi
